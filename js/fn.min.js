config.fn={calculateOffset:function(e,t,n){var a=[],r=function(e,n){for(var l=0;l<e.length;l++){var o=e[l];if(o===t)return a[n]=o,!0;o.children.length&&(a[n]=o,r(o.children,n+1))}return!1};r(e.tree.root.children,0);var l=0,o=0;for(i=0;i<a.length;i++)l+=a[i].styles[e.flags.screenState][e.flags.elementState].lPx+a[i].styles[e.flags.screenState][e.flags.elementState].bwPx,o+=a[i].styles[e.flags.screenState][e.flags.elementState].tPx+a[i].styles[e.flags.screenState][e.flags.elementState].bwPx;var c=n.lPx,s=n.tPx,d=c-l,f=s-o;return{left:d+"px",lPx:d,top:f+"px",tPx:f}},pxNum:function(e){return 0!==e?parseInt(e.replace(/[^-\d\.]/g,"")):0},findControllerScope:function(e){return null===e.$parent.$parent?e:config.fn.findControllerScope(e.$parent)},modifiers:{modifyElementAreaWithKeystroke:function(e,t,n){2==e.data.selection.active.typeNum&&0===$("[area-key-increment]:focus,[x-key-increment]:focus").length&&e.data.fn.modifiers.modifyElementArea(e,t,n)},setElementArea:function(e,t,n){"undefined"==typeof n&&(n=!1);var a,r,l,o=e.data.screen.overflow,i=e.data.flags.elementState,c=e.data.flags.screenState,s=e.data.tools.selection,d=s.element,f=s.eInitPos;switch(t){case"top":if(l=n===!0?-1*e.data.mouse.dragDelta.y:e.data.mouse.dragDelta.y,a=f.tPx+l,r="tPx",!o){var u=e.data.screen.hPx-d.styles[c][i].hPx;0>a&&(a=0),a>u&&(a=u)}break;case"left":if(l=n===!0?-1*e.data.mouse.dragDelta.x:e.data.mouse.dragDelta.x,a=f.lPx+l,r="lPx",!o){var g=e.data.screen.wPx-d.styles[c][i].wPx;0>a&&(a=0),a>g&&(a=g)}break;case"height":if(l=e.data.mouse.dragDelta.y,n&&(minDelta=f.tPx,l=-1*l),r="hPx",a=f.hPx+l,!o){var p=d.styles[c][i].tPx;if(n===!0&&l>minDelta)a=d.styles[c][i].hPx;else{var h=e.data.screen.hPx-p;a>h&&(a=h)}}break;case"width":if(l=e.data.mouse.dragDelta.x,n&&(minDelta=f.lPx,l=-1*l),r="wPx",a=f.wPx+l,!o){var y=d.styles[c][i].lPx;if(n===!0&&l>minDelta)a=d.styles[c][i].wPx;else{var m=e.data.screen.wPx-y;a>m&&(a=m)}}}d.styles[c][i][r]=a,d.styles[c][i][t]=a+"px","$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},modifyElementArea:function(e,t,n,a){"undefined"==typeof a&&(a=e.data.selection.active);var r=e.data.screen.overflow,l=e.data.flags.elementState,o=e.data.flags.screenState,i=e.data.fn.modifiers.cssIncrement(a.styles[o][l][t],n);if(!r)switch(t){case"top":var c=e.data.screen.hPx-a.styles[o][l].hPx;i.unitLess<0&&(i={val:"0px",unitLess:0}),i.unitLess>c&&(i={val:c+"px",unitLess:c});break;case"left":var s=e.data.screen.wPx-a.styles[o][l].wPx;i.unitLess<0&&(i={val:"0px",unitLess:0}),i.unitLess>s&&(i={val:s+"px",unitLess:s});break;case"height":var d=e.data.screen.hPx-a.styles[o][l].tPx;i.unitLess>d&&(i={val:d+"px",unitLess:d});break;case"width":var f=e.data.screen.wPx-a.styles[o][l].lPx;i.unitLess>f&&(i={val:f+"px",unitLess:f})}a.styles[o][l][t]=i.val,"undefined"!=typeof a.styles[o][l][t.substr(0,1)+"Px"]&&(a.styles[o][l][t.substr(0,1)+"Px"]=i.unitLess),"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},movementDelta:function(e,t){return{xPx:e.lPx-t.lPx,yPx:e.tPx-t.tPx}},cssIncrement:function(e,t){e||(e="0px");var n=parseInt(e.replace(/[^-\d\.]/g,"")),a=n+t,r=e.replace(n,"");return{val:a+(""===r?"px":r),unitLess:a}},setStyle:function(e,t,n,a,r){"undefined"==typeof e[t][n]&&(e.styles[t][n]={}),e.styles[t][n][a]=r},getStyle:function(e,t,n,a,r){return"undefined"==typeof r&&(r=!1),"undefined"==typeof e.styles[t][n]&&(e.styles[t][n]={}),"undefined"==typeof e.styles[t][n][a]&&(e.styles[t][n][a]=r?e.styles.base.normal[a]:""),e.styles[t][n][a]}},fireModal:function(e,t){var n=$("body"),a='<div class="modal-backdrop" modal>{{data.modal.content}}</div>',r=t(a)(e);n.append(r)},killModal:function(){angular.element(document.querySelector(".modal-backdrop")).remove()},setTool:function(e,t,n,a){t.on("click",function(){e.data.fn.initTool(e,n,a)}),"true"==n.isDefault&&e.data.fn.initTool(e,n,a)},initTool:function(e,t,n){var a=e.data.tools;a[e.data.tool].destroy(e),a[e.data.tool].isActive=!1,e.data.tool=t.setTool,a[e.data.tool].init(n,e),a[e.data.tool].isActive=!0;try{"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()}catch(r){}},varHider:function(e){console.log(e),e=!1},tree:{dragLeave:function(e,t,n){e.preventDefault(),n.removeClass("drag-over")},dragOver:function(e,t,n){e.preventDefault(),n.addClass("drag-over")},dropLayer:function(e,t){var n=config.fn.findControllerScope(t),a=n.data.tree.root,r=a.children.indexOf(t.child),l=$.extend(!0,{},n.data.uhaul);a.children.splice(a.children.indexOf(n.data.uhaul),1),a.children.splice(r,0,l),n.data.flags.dragType=null,"$apply"!=t.$root.$$phase&&"$digest"!=t.$root.$$phase&&t.$apply()},drop:function(e,t){var n=config.fn.findControllerScope(t),a=n.data.fn.tree.selectParentLayer(n.data.tree.root.children,t.child),r=a.children.indexOf(t.child),l=$.extend(!0,{},n.data.uhaul),o=n.data.fn.tree.selectParentLayer(n.data.tree.root.children,n.data.uhaul);o.children.splice(o.children.indexOf(n.data.uhaul),1),a.children.splice(r,0,l),n.data.flags.dragType=null,"$apply"!=t.$root.$$phase&&"$digest"!=t.$root.$$phase&&t.$apply()},startDrag:function(e,t){var n=config.fn.findControllerScope(t);n.data.flags.dragType=t.dataElement.typeNum,n.data.uhaul=t.dataElement,n.data.fn.tree.toggleSelected({child:t.dataElement,data:n.data}),"$apply"!=t.$root.$$phase&&"$digest"!=t.$root.$$phase&&t.$apply()},duplicateActive:function(e){var t=e.selection.active,n=2==t.typeNum?e.fn.tree.selectParentLayer(e.tree.root.children):e.tree.root;if(t){childCopy=$.extend(!0,{},t);var a=function(e){var t=function(e){var t=e.split("_copy_");return copyNumber=parseInt(t[t.length-1]),copyNumber=isNaN(copyNumber)?1:copyNumber+1,t[0]+"_copy_"+copyNumber};if(e.id=t(e.id),e.selected=!1,e.children.length>0)for(var n=0;n<e.children.length;n++)a(e.children[n])};a(childCopy),n.children.push(childCopy),config.fn.tree.toggleSelected({child:n.children[n.children.length-1],data:e})}},reset:function(e){e.tree.root=angular.merge({},e.baseObject)},set:function(e,t){e=angular.merge({},t)},removeSelected:function(e,t){t.fn.tree.remove(t.fn.tree.returnSelected(e.children),t)},remove:function(e,t){function n(t){var a,r=t.children;if(r)for(a=r.length;a--;){if(r[a]===e)return r.splice(a,1);n(r[a])}}n(t.tree.root),t.fn.tree.toggleSelected({child:t.selection.prev?t.selection.prev:t.selection.next?t.selection.next:t.selection.parent?t.selection.parent:null,data:t})},returnSelected:function(e){var t=function(e){for(var n=0;n<e.length;n++){var a=e[n];if(a.selected===!0)return a;var r=t(a.children);if(a.children.length>0&&r)return r}return!1};return t(e)},addChild:function(e,t){e.children.push({id:t.fn.tree.newLayerName({pre:null,data:t}),children:[],selected:!1,locked:!1,visible:!0,styles:{base:{normal:{top:"0",tPx:0,left:"0",lPx:0,width:"0",wPx:0,height:"0",hPx:0,overflow:"visible","border-width":"0px",bwPx:0,opacity:1,"mix-blend-mode":"normal"}}},type:"root"==e.type?"layer":"element",typeNum:0===e.typeNum?1:2}),t.fn.tree.toggleSelected({child:e.children[e.children.length-1],data:t})},selectParentLayer:function(e,t){var n=null,a=function(e){for(var r=0;r<e.length;r++){var l=e[r];if("layer"==l.type&&(n=l),"undefined"==typeof t){if(l.selected===!0)return n}else if(l===t)return n;if(l.children.length>0&&a(l.children))return n}return!1};return a(e)},searchElementById:function(e,t){var n=function(t){for(var a=0;a<t.length;a++){var r=t[a];if(r.id===e)return r;var l=n(r.children);if(r.children.length>0&&l)return l}return!1};return n(t)},toggleSelected:function(e){var t=e.child,n=e.data;t&&(n.fn.tree.unSelect(n),t.selected=!0,n.fn.tree.logSelection({child:t,data:n}))},logSelection:function(e){var t=(e.child,e.data),n=null,a=function(e){for(var t=0;t<e.length;t++){var r=e[t];if("layer"==r.type&&(n=r),r.selected===!0)return{active:r,next:t+1<e.length?e[t+1]:null,prev:t-1>-1?e[t-1]:null,parent:"layer"==r.type?null:n};if(r.children.length>0){var l=a(r.children);if(l)return l}}return!1};t.selection=a(t.tree.root.children)},unSelect:function(e){function t(e){var n,a=e.children;if(a)for(n=a.length;n--;){if(a[n].selected){a[n].selected=!1;break}t(a[n])}}t(e.tree.root)},toggleMinimized:function(e){e.minimized=!e.minimized},newLayerName:function(e){for(var t,n=e.data,a="undefined"!=typeof e.pre&&e.pre?e.pre:n.lang[n.lang.act].layer,r=1,l=function(e,t){for(var n=0;n<t.length;n++){var a=t[n];if(a.id==e)return!0;if(a.children.length>0&&l(e,a.children))return!0}return!1};r;){if(t=a+"_"+r,!l(t,n.tree.root.children))return t;r++}}},storage:{getEverything:function(){return window.localStorage},filterData:function(e,t){var n=[];for(var a in e)0===a.indexOf("pinocchio_"+t+"__")&&n.push(angular.fromJson(e[a]));return n},getDocuments:function(){return config.fn.storage.filterData(config.fn.storage.getEverything(),"document")},getDocumentNames:function(){for(var e=config.fn.storage.getDocuments(),t=[],n=0;n<e.length;n++)t.push({id:e[n].tree.root.id,name:e[n].tree.root.name});return t},checkName:function(e){for(var t=config.fn.storage.getDocuments(),n=0;n<t.length;n++)if(t[n].tree.root.name==e)return!0;return!1},sanitizeName:function(e){return e.toLowerCase().replace(/\s/g,"_")},saveDocument:function(e){config.fn.storage.storeDocument(e)},storeDocument:function(e){var t=e.data.tree.root.name,n={screen:angular.merge({},e.data.screen),tree:angular.merge({},e.data.tree)},a=angular.toJson(n);config.fn.storage.store("document",a,config.fn.storage.sanitizeName(t))},retrieveDocument:function(e){return localStorage[e]},getDocumentObjectById:function(e){return angular.fromJson(config.fn.storage.retrieveDocument("pinocchio_"+e))},store:function(e,t,n){localStorage.setItem("pinocchio_"+e+"__"+n,t)}},documents:{open:function(e,t,n){if(t){var a=e.data.fn.storage.getDocumentObjectById(t);e.data.fn.tree.reset(e.data),e.data.flags.storage.canOverwrite=!0,e.data.screen=a.screen,e.data.tree=a.tree,e.data.fn.tree.toggleSelected({child:e.data.fn.tree.searchElementById("layer_1",e.data.tree.root.children),data:e.data}),n()}}}};