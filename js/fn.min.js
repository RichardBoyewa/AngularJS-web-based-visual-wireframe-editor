config.fn={calculateOffset:function(e,t,n){var r=[],a=function(e,n){for(var o=0;o<e.length;o++){var i=e[o];if(i===t)return r[n]=i,!0;i.children.length&&(r[n]=i,a(i.children,n+1))}return!1};a(e.tree.root.children,0);var o=0,l=0;for(i=0;i<r.length;i++)o+=r[i].style.lPx+r[i].style.bwPx,l+=r[i].style.tPx+r[i].style.bwPx;var c=n.lPx,s=n.tPx,u=c-o,f=s-l;return{left:u+"px",lPx:u,top:f+"px",tPx:f}},pxNum:function(e){return 0!==e?parseInt(e.replace(/[^-\d\.]/g,"")):0},modifiers:{modifyElementAreaWithKeystroke:function(e,t,n){2==e.data.selection.active.typeNum&&0===$("[area-key-increment]:focus,[x-key-increment]:focus").length&&e.data.fn.modifiers.modifyElementArea(e,t,n)},modifyElementArea:function(e,t,n){var r=e.data.screen.overflow,a=e.data.fn.modifiers.cssIncrement(e.data.selection.active.style[t],n);if(!r)switch(t){case"top":var o=e.data.screen.hPx-e.data.selection.active.style.hPx;a.unitLess<0&&(a={val:"0px",unitLess:0}),a.unitLess>o&&(a={val:o+"px",unitLess:o});break;case"left":var i=e.data.screen.wPx-e.data.selection.active.style.wPx;a.unitLess<0&&(a={val:"0px",unitLess:0}),a.unitLess>i&&(a={val:i+"px",unitLess:i});break;case"height":var l=e.data.screen.hPx-e.data.selection.active.style.tPx;a.unitLess>l&&(a={val:l+"px",unitLess:l});break;case"width":var c=e.data.screen.wPx-e.data.selection.active.style.lPx;a.unitLess>c&&(a={val:c+"px",unitLess:c})}e.data.selection.active.style[t]=a.val,"undefined"!=typeof e.data.selection.active.style[t.substr(0,1)+"Px"]&&(e.data.selection.active.style[t.substr(0,1)+"Px"]=a.unitLess),e.$apply()},cssIncrement:function(e,t){var n=parseInt(e.replace(/[^-\d\.]/g,"")),r=n+t,a=e.replace(n,"");return{val:r+(""===a?"px":a),unitLess:r}}},fireModal:function(e,t){var n=$("body"),r='<div class="modal-backdrop" modal>{{data.modal.content}}</div>',a=t(r)(e);n.append(a)},killModal:function(){angular.element(document.querySelector(".modal-backdrop")).remove()},setTool:function(e,t,n,r){t.on("click",function(){e.data.fn.initTool(e,n,r)}),"true"==n.isDefault&&e.data.fn.initTool(e,n,r)},initTool:function(e,t,n){var r=e.data.tools;r[e.data.tool].destroy(e),r[e.data.tool].isActive=!1,$("#canvas").removeClass(e.data.tool),e.data.tool=t.setTool,r[e.data.tool].init(n,e),r[e.data.tool].isActive=!0,$("#canvas").addClass(e.data.tool)},varHider:function(e){console.log(e),e=!1},tree:{reset:function(e){e.tree.root=angular.merge({},e.baseObject)},set:function(e,t){e=angular.merge({},t)},removeSelected:function(e,t){t.fn.tree.remove(t.fn.tree.returnSelected(e.children),t)},remove:function(e,t){function n(t){var r,a=t.children;if(a)for(r=a.length;r--;){if(a[r]===e)return a.splice(r,1);n(a[r])}}n(t.tree.root),t.fn.tree.toggleSelected({child:t.selection.prev?t.selection.prev:t.selection.next?t.selection.next:t.selection.parent?t.selection.parent:null,data:t})},returnSelected:function(e){var t=function(e){for(var n=0;n<e.length;n++){var r=e[n];if(r.selected===!0)return r;var a=t(r.children);if(r.children.length>0&&a)return a}return!1};return t(e)},addChild:function(e,t){e.children.push({id:t.fn.tree.newLayerName({pre:null,data:t}),children:[],selected:!1,style:{top:"0",tPx:0,left:"0",lPx:0,width:"0",wPx:0,height:"0",hPx:0,overflow:"visible","border-width":"0px",bwPx:0},type:"root"==e.type?"layer":"element",typeNum:0===e.typeNum?1:2}),t.fn.tree.toggleSelected({child:e.children[e.children.length-1],data:t})},selectParentLayer:function(e){var t=null,n=function(e){for(var r=0;r<e.length;r++){var a=e[r];if("layer"==a.type&&(t=a),a.selected===!0)return t;if(a.children.length>0&&n(a.children))return t}return!1};return n(e)},searchElementById:function(e,t){var n=function(t){for(var r=0;r<t.length;r++){var a=t[r];if(a.id===e)return a;var o=n(a.children);if(a.children.length>0&&o)return o}return!1};return n(t)},toggleSelected:function(e){var t=e.child,n=e.data;t&&(n.fn.tree.unSelect(n),t.selected=!0,n.fn.tree.logSelection({child:t,data:n}))},logSelection:function(e){var t=(e.child,e.data),n=null,r=function(e){for(var t=0;t<e.length;t++){var a=e[t];if("layer"==a.type&&(n=a),a.selected===!0)return{active:a,next:t+1<e.length?e[t+1]:null,prev:t-1>-1?e[t-1]:null,parent:"layer"==a.type?null:n};if(a.children.length>0){var o=r(a.children);if(o)return o}}return!1};t.selection=r(t.tree.root.children)},unSelect:function(e){function t(e){var n,r=e.children;if(r)for(n=r.length;n--;){if(r[n].selected){r[n].selected=!1;break}t(r[n])}}t(e.tree.root)},toggleMinimized:function(e){e.minimized=!e.minimized},newLayerName:function(e){for(var t,n=e.data,r="undefined"!=typeof e.pre&&e.pre?e.pre:n.lang[n.lang.act].layer,a=1,o=function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(r.id==e)return!0;if(r.children.length>0&&o(e,r.children))return!0}return!1};a;){if(t=r+"_"+a,!o(t,n.tree.root.children))return t;a++}}},storage:{getEverything:function(){return window.localStorage},filterData:function(e,t){var n=[];for(var r in e)0===r.indexOf("pinocchio_"+t+"__")&&n.push(angular.fromJson(e[r]));return n},getDocuments:function(){return config.fn.storage.filterData(config.fn.storage.getEverything(),"document")},getDocumentNames:function(){for(var e=config.fn.storage.getDocuments(),t=[],n=0;n<e.length;n++)t.push({id:e[n].tree.root.id,name:e[n].tree.root.name});return t},checkName:function(e){var t=config.fn.storage.getDocuments();console.log(t);for(var n=0;n<t.length;n++)if(t[n].tree.root.name==e)return!0;return!1},sanitizeName:function(e){return e.toLowerCase().replace(/\s/g,"_")},saveDocument:function(e){config.fn.storage.storeDocument(e)},storeDocument:function(e){var t=e.data.tree.root.name,n={screen:angular.merge({},e.data.screen),tree:angular.merge({},e.data.tree)},r=angular.toJson(n);config.fn.storage.store("document",r,config.fn.storage.sanitizeName(t))},retrieveDocument:function(e){return console.log(e),localStorage[e]},getDocumentObjectById:function(e){return console.log(e),angular.fromJson(config.fn.storage.retrieveDocument("pinocchio_"+e))},store:function(e,t,n){localStorage.setItem("pinocchio_"+e+"__"+n,t)}},flyoutMenu:{toggle:function(e,t){for(var n in t.menus)t.menus[n].active=!1;e.active=!0},activate:function(e,t){e.active=!e.active,$(document).one("click",function(){$(document).one("click",function(){e.active=!1,t.$apply()})})}}};