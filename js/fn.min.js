config.fn={calculateOffset:function(e,t,n){var r=[],o=function(e,n){for(var a=0;a<e.length;a++){var i=e[a];if(i===t)return r[n]=i,!0;i.children.length&&(r[n]=i,o(i.children,n+1))}return!1};o(e.tree.root.children,0);var a=0,l=0;for(i=0;i<r.length;i++)a+=r[i].styles.normal.lPx+r[i].styles.normal.bwPx,l+=r[i].styles.normal.tPx+r[i].styles.normal.bwPx;var c=n.lPx,s=n.tPx,u=c-a,f=s-l;return{left:u+"px",lPx:u,top:f+"px",tPx:f}},pxNum:function(e){return 0!==e?parseInt(e.replace(/[^-\d\.]/g,"")):0},findControllerScope:function(e){return null===e.$parent.$parent?e:findControllerScope(e.$parent)},modifiers:{modifyElementAreaWithKeystroke:function(e,t,n){2==e.data.selection.active.typeNum&&0===$("[area-key-increment]:focus,[x-key-increment]:focus").length&&e.data.fn.modifiers.modifyElementArea(e,t,n)},modifyElementArea:function(e,t,n){var r=e.data.screen.overflow,o=e.data.fn.modifiers.cssIncrement(e.data.selection.active.styles.normal[t],n);if(!r)switch(t){case"top":var a=e.data.screen.hPx-e.data.selection.active.styles.normal.hPx;o.unitLess<0&&(o={val:"0px",unitLess:0}),o.unitLess>a&&(o={val:a+"px",unitLess:a});break;case"left":var i=e.data.screen.wPx-e.data.selection.active.styles.normal.wPx;o.unitLess<0&&(o={val:"0px",unitLess:0}),o.unitLess>i&&(o={val:i+"px",unitLess:i});break;case"height":var l=e.data.screen.hPx-e.data.selection.active.styles.normal.tPx;o.unitLess>l&&(o={val:l+"px",unitLess:l});break;case"width":var c=e.data.screen.wPx-e.data.selection.active.styles.normal.lPx;o.unitLess>c&&(o={val:c+"px",unitLess:c})}e.data.selection.active.styles.normal[t]=o.val,"undefined"!=typeof e.data.selection.active.styles.normal[t.substr(0,1)+"Px"]&&(e.data.selection.active.styles.normal[t.substr(0,1)+"Px"]=o.unitLess),e.$apply()},cssIncrement:function(e,t){e||(e="0px");var n=parseInt(e.replace(/[^-\d\.]/g,"")),r=n+t,o=e.replace(n,"");return{val:r+(""===o?"px":o),unitLess:r}},setStyle:function(e,t,n,r){"undefined"==typeof e[t]&&(e.styles[t]={}),e.styles[t][n]=r},getStyle:function(e,t,n){return"undefined"==typeof e.styles[t]&&(e.styles[t]={}),"undefined"==typeof e.styles[t][n]&&(e.styles[t][n]=""),e.styles[t][n]}},fireModal:function(e,t){var n=$("body"),r='<div class="modal-backdrop" modal>{{data.modal.content}}</div>',o=t(r)(e);n.append(o)},killModal:function(){angular.element(document.querySelector(".modal-backdrop")).remove()},setTool:function(e,t,n,r){t.on("click",function(){e.data.fn.initTool(e,n,r)}),"true"==n.isDefault&&e.data.fn.initTool(e,n,r)},initTool:function(e,t,n){var r=e.data.tools;r[e.data.tool].destroy(e),r[e.data.tool].isActive=!1,e.data.tool=t.setTool,r[e.data.tool].init(n,e),r[e.data.tool].isActive=!0,"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},varHider:function(e){console.log(e),e=!1},tree:{reset:function(e){e.tree.root=angular.merge({},e.baseObject)},set:function(e,t){e=angular.merge({},t)},removeSelected:function(e,t){t.fn.tree.remove(t.fn.tree.returnSelected(e.children),t)},remove:function(e,t){function n(t){var r,o=t.children;if(o)for(r=o.length;r--;){if(o[r]===e)return o.splice(r,1);n(o[r])}}n(t.tree.root),t.fn.tree.toggleSelected({child:t.selection.prev?t.selection.prev:t.selection.next?t.selection.next:t.selection.parent?t.selection.parent:null,data:t})},returnSelected:function(e){var t=function(e){for(var n=0;n<e.length;n++){var r=e[n];if(r.selected===!0)return r;var o=t(r.children);if(r.children.length>0&&o)return o}return!1};return t(e)},addChild:function(e,t){e.children.push({id:t.fn.tree.newLayerName({pre:null,data:t}),children:[],selected:!1,locked:!1,visible:!0,styles:{normal:{top:"0",tPx:0,left:"0",lPx:0,width:"0",wPx:0,height:"0",hPx:0,overflow:"visible","border-width":"0px",bwPx:0}},type:"root"==e.type?"layer":"element",typeNum:0===e.typeNum?1:2}),t.fn.tree.toggleSelected({child:e.children[e.children.length-1],data:t})},selectParentLayer:function(e){var t=null,n=function(e){for(var r=0;r<e.length;r++){var o=e[r];if("layer"==o.type&&(t=o),o.selected===!0)return t;if(o.children.length>0&&n(o.children))return t}return!1};return n(e)},searchElementById:function(e,t){var n=function(t){for(var r=0;r<t.length;r++){var o=t[r];if(o.id===e)return o;var a=n(o.children);if(o.children.length>0&&a)return a}return!1};return n(t)},toggleSelected:function(e){var t=e.child,n=e.data;t&&(n.fn.tree.unSelect(n),t.selected=!0,n.fn.tree.logSelection({child:t,data:n}))},logSelection:function(e){var t=(e.child,e.data),n=null,r=function(e){for(var t=0;t<e.length;t++){var o=e[t];if("layer"==o.type&&(n=o),o.selected===!0)return{active:o,next:t+1<e.length?e[t+1]:null,prev:t-1>-1?e[t-1]:null,parent:"layer"==o.type?null:n};if(o.children.length>0){var a=r(o.children);if(a)return a}}return!1};t.selection=r(t.tree.root.children)},unSelect:function(e){function t(e){var n,r=e.children;if(r)for(n=r.length;n--;){if(r[n].selected){r[n].selected=!1;break}t(r[n])}}t(e.tree.root)},toggleMinimized:function(e){e.minimized=!e.minimized},newLayerName:function(e){for(var t,n=e.data,r="undefined"!=typeof e.pre&&e.pre?e.pre:n.lang[n.lang.act].layer,o=1,a=function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(r.id==e)return!0;if(r.children.length>0&&a(e,r.children))return!0}return!1};o;){if(t=r+"_"+o,!a(t,n.tree.root.children))return t;o++}}},storage:{getEverything:function(){return window.localStorage},filterData:function(e,t){var n=[];for(var r in e)0===r.indexOf("pinocchio_"+t+"__")&&n.push(angular.fromJson(e[r]));return n},getDocuments:function(){return config.fn.storage.filterData(config.fn.storage.getEverything(),"document")},getDocumentNames:function(){for(var e=config.fn.storage.getDocuments(),t=[],n=0;n<e.length;n++)t.push({id:e[n].tree.root.id,name:e[n].tree.root.name});return t},checkName:function(e){var t=config.fn.storage.getDocuments();console.log(t);for(var n=0;n<t.length;n++)if(t[n].tree.root.name==e)return!0;return!1},sanitizeName:function(e){return e.toLowerCase().replace(/\s/g,"_")},saveDocument:function(e){config.fn.storage.storeDocument(e)},storeDocument:function(e){var t=e.data.tree.root.name,n={screen:angular.merge({},e.data.screen),tree:angular.merge({},e.data.tree)},r=angular.toJson(n);config.fn.storage.store("document",r,config.fn.storage.sanitizeName(t))},retrieveDocument:function(e){return console.log(e),localStorage[e]},getDocumentObjectById:function(e){return console.log(e),angular.fromJson(config.fn.storage.retrieveDocument("pinocchio_"+e))},store:function(e,t,n){localStorage.setItem("pinocchio_"+e+"__"+n,t)}}};