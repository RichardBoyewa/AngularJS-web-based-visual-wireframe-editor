angular.module("gui.directives",["gui.filters"]).directive("keyIncrement",[function(){return{scope:{model:"=ngModel",unitlessValue:"=unitlessValue"},link:function(e,t){t.on("keydown",function(t){if(e.model){var n,i=t.keyCode;40==i?n=e.$parent.data.fn.cssIncrement(e.model,-1):38==i&&(n=e.$parent.data.fn.cssIncrement(e.model,1)),e.model=n.val,e.unitlessValue=n.unitLess,e.$apply()}})}}}]).directive("toolbox",["launcherFilter",function(){return{scope:{toolbox:"@toolbox",data:"=data"},template:'<button ng-repeat="(key,value) in data.tools | launcher:toolbox" type="button" class="btn" ng-class="{active: value.isActive}" set-tool="{{value.id}}" title="{{value.label}}" ng-attr-is-default="{{value.isDefault}}"><span class="{{value.iconClass}}"></span></button>'}}]).directive("setTool",["$compile",function(e){return{link:function(t,n,i){t.data.fn.setTool(t,n,i,e)}}}]).directive("trackMouseEvents",["$compile",function(e){return function(t,n){n.on("mousedown mouseup mouseenter mouseleave",function(n){n.preventDefault();var i=n.target,a=t.data.tools,o=$("#horizontalRuler"),c=$("#rulerHGuide"),l=$("#verticalRuler"),s=$("#rulerVGuide"),r=$("#rulers"),u={event:n,scope:t,compile:e};i==o||i==c?a.addGuide.horizontal[n.type](u):i==l||i==s?a.addGuide.vertical[n.type](u):i==r||(a.addGuide.isActive?a.addGuide[a.addGuide.isActive][n.type](u):("function"==typeof a[t.data.tool].setUndo&&a[t.data.tool].setUndo(u),"function"==typeof a[t.data.tool][n.type]&&a[t.data.tool][n.type](u)))})}}]).directive("trackMousePosition",[function(){return function(e,t){t.on("mousemove",function(t){var n=$("#screen").offset();e.$apply(function(){e.data.mouse.y=t.pageX,e.data.mouse.x=t.pageY,e.data.screen.mouse.x=t.pageX-n.left,e.data.screen.mouse.y=t.pageY-n.top}),e.data.tools[e.data.tool].mousemove(t,e)})}}]).directive("modal",[function(){return{transclude:!0,templateUrl:"templates/modal.html",scope:{},link:function(e,t){e.content="Hello modals",t.on("click",function(e){e.target==t[0]&&t.remove()})}}}]).directive("showElements",function(e){return{scope:{family:"="},templateUrl:"templates/tree.html",compile:function(t){return e.compile(t)}}}).directive("tree",function(){return{restrict:"A",transclude:"element",priority:1e3,terminal:!0,compile:function(e,t,n){var i,a,o,c,l;return i=t.tree.match(/^(.*) in ((?:.*\.)?(.*)) at (.*)$/),a=i[1],o=i[2],c=i[3],l=i[4],function(e,t){function i(e){for(var t=r.length;t--;)if(r[t].scope[a]===e)return r.splice(t,1)[0]}var s=t[0].parentNode,r=[];e.$watch(o,function(t){var o=[],u=function(e,t,s,d){for(var p,y,f,h,m,v=0,k=e.length,w=k-1,$=function(e,n){n[a]=y,f={scope:n,parentScope:s,element:e[0],branch:"none"==l?e[0]:e.find(l)[0]},t.insertBefore(f.element,p)};k>v;++v)p=t.childNodes[v],y=e[v],f=i(y),f&&f.parentScope!==s&&(r.push(f),f=null),f?f.element!==p&&t.insertBefore(f.element,p):n(s.$new(),$),h=f.scope,h.$depth=d,h.$index=v,h.$first=0===v,h.$last=v===w,h.$middle=!(h.$first||h.$last),o.push(f),m=y[c],m&&m.length&&u(m,f.branch,h,d+1)};u(t,s,e,0);for(var d=r.length;d--;){var p=r[d];p.scope&&p.scope.$destroy(),p.element&&p.element.parentNode.removeChild(p.element)}r=o},!0)}}}}).directive("colorPicker",["$compile",function(){return{scope:{which:"@which"},template:'<div class="tr-sq"><input type="text" class="swatch" style="background-color:{{$parent.data.stylePickers[which]}}" ng-model="$parent.data.stylePickers[which]" colorpicker="rgba"  colorpicker-position="value" colorpicker-position-value="-100,40" colorpicker-parent colorpicker-with-input="true" /></div>',link:function(e){var t=e.$parent;"undefined"==typeof t.data.stylePickers&&(t.stylePickers={}),t.data.stylePickers[e.which]=t.data.drawStyle[e.which];var n=function(){var n=t.data.selection.active;t.data.stylePickers[e.which]="layer"==n.type?t.data.drawStyle[e.which]:n.style[e.which]};n(),t.$watch("data.selection",function(){n()}),t.$watch('data.stylePickers["'+e.which+'"]',function(n){"layer"==t.data.selection.active.type?t.data.drawStyle[e.which]=n:t.data.selection.active.style[e.which]=n})}}}]).directive("drawstyleSelectionModifier",["$compile",function(){return{scope:{inputType:"@inputType",inputClass:"@inputClass",which:"@which"},template:'<input type="{{inputType}}" class="{{inputClass}}" which="{{which}}" ng-model="$parent.data.stylePickers[which]" x-key-increment />',link:function(e){s=e.$parent,"undefined"==typeof s.data.stylePickers&&(s.data.stylePickers={}),s.data.stylePickers[e.which]=s.data.drawStyle[e.which];var t=function(){var t=s.data.selection.active;s.data.stylePickers[e.which]="layer"==t.type?s.data.drawStyle[e.which]:t.style[e.which]};t(),s.$watch("data.selection",function(){t()}),s.$watch('data.stylePickers["'+e.which+'"]',function(t){"layer"==s.data.selection.active.type?s.data.drawStyle[e.which]=t:s.data.selection.active.style[e.which]=t})}}}]).directive("listenKeystrokes",["$compile",function(e){return function(t){$(window).on("keydown.listenKeystrokes keyup.listenKeystrokes",function(n){console.log(n),"undefined"!=typeof t.data.keystrokes[n.keyCode]&&"undefined"!=typeof t.data.keystrokes[n.keyCode][n.type]&&t.data.keystrokes[n.keyCode][n.type]({e:n,s:t,c:e})})}}]).directive("flyoutMenu",[function(){return{restrict:"A",scope:{menu:"=flyoutMenu"},template:'<span ng-class="menu.iconClass" ng-attr-title="menu.label" ng-click="menu.visible = !menu.visible"></span><div class="flyout" ng-show="menu.visible"><button ng-repeat="action in menu.actions" ng-click="action.fn($parent)" ng-disabled="action.disabled">{{action.label}}</button></div>'}}]);