angular.module("gui.directives",["gui.filters"]).directive("checkbox",[function(){return{scope:{model:"=ngModel",label:"@label",iconChecked:"@iconChecked",iconUnchecked:"@iconUnchecked"},template:'<span ng-click="model= !model"><i class="custom-checkbox {{{true:iconChecked,false:iconUnchecked}[model]}}"></i><label>{{::label}}</label></span>'}}]).directive("keyIncrement",[function(){return{scope:{model:"=ngModel",unitlessValue:"=unitlessValue"},link:function(e,t){t.on("keydown",function(t){var n=t.keyCode;if(40==n||38==n){var a,o=function(e){return null===e.$parent.$parent?e:o(e.$parent)},i=o(e);40==n?a=i.data.fn.modifiers.cssIncrement(e.model,-1):38==n&&(a=i.data.fn.modifiers.cssIncrement(e.model,1)),e.model=a.val,e.unitlessValue=a.unitLess,e.$apply()}})}}}]).directive("areaKeyIncrement",[function(){return{link:function(e,t,n){t.on("keydown",function(t){var a,o=t.keyCode;console.log(n.ngProperty),40==o?(t.preventDefault(),a=e.data.fn.modifiers.modifyElementArea(e,n.ngProperty,-1)):38==o&&(t.preventDefault(),a=e.data.fn.modifiers.modifyElementArea(e,n.ngProperty,1))})}}}]).directive("toolbox",["launcherFilter",function(){return{scope:{toolbox:"@toolbox",data:"=data"},template:'<button ng-repeat="(key,value) in data.tools | launcher:toolbox" type="button" class="btn" ng-class="{active: value.isActive}" set-tool="{{::value.id}}" title="{{::value.label}}" ng-attr-is-default="{{value.isDefault}}"><span class="{{::value.iconClass}}"></span></button>'}}]).directive("setTool",["$compile",function(e){return{link:function(t,n,a){t.data.fn.setTool(t,n,a,e)}}}]).directive("trackMouseEvents",["$compile",function(e){return function(t,n){n.on("mousedown mouseup mouseenter mouseleave touchstart touchend",function(n){n.preventDefault();var a=n.target,o=t.data.tools,i=$("#horizontalRuler"),r=$("#rulerHGuide"),l=$("#verticalRuler"),c=$("#rulerVGuide"),s=$("#rulers"),u={event:n,scope:t,compile:e};("mousedown"==n.type||"touchstart"==n.type)&&($(":focus").blur(),t.data.mouse.down.x=n.pageX,t.data.mouse.down.y=n.pageY,t.data.mouse.offset.down.x=n.offsetX,t.data.mouse.offset.down.y=n.offsetY),("mouseup"==n.type||"touchend"==n.type)&&(t.data.mouse.up.x=n.pageX,t.data.mouse.up.y=n.pageY,t.data.mouse.offset.up.x=n.offsetX,t.data.mouse.offset.up.y=n.offsetY),t.data.flags.mouseEvent=n.type,a==i||a==r?o.addGuide.horizontal[n.type](u):a==l||a==c?o.addGuide.vertical[n.type](u):a==s||(o.addGuide.isActive?o.addGuide[o.addGuide.isActive][n.type](u):("function"==typeof o[t.data.tool].setUndo&&o[t.data.tool].setUndo(u),"function"==typeof o[t.data.tool][n.type]&&o[t.data.tool][n.type](u)))})}}]).directive("trackMousePosition",[function(){return function(e,t){t.on("mousemove touchmove",function(t){var n=$("#screen").offset();e.$apply(function(){e.data.mouse.x=t.pageX,e.data.mouse.y=t.pageY,e.data.mouse.offset.x=t.pageX,e.data.mouse.offset.y=t.pageY,e.data.screen.mouse.x=t.pageX-n.left,e.data.screen.mouse.y=t.pageY-n.top,"mousedown"==e.data.flags.mouseEvent&&(e.data.mouse.dragDelta.x=t.pageX-e.data.mouse.down.x,e.data.mouse.dragDelta.y=t.pageY-e.data.mouse.down.y)}),e.data.tools[e.data.tool].mousemove(t,e)})}}]).directive("modal",[function(){return{transclude:!0,templateUrl:"templates/modal.html",scope:{},link:function(e,t){e.content="Hello modals",t.on("click",function(e){e.target==t[0]&&t.remove()})}}}]).directive("showElements",function(e){return{scope:{family:"="},templateUrl:"templates/tree.html",compile:function(t){return e.compile(t)}}}).directive("tree",function(){return{restrict:"A",transclude:"element",priority:1e3,terminal:!0,compile:function(e,t,n){var a,o,i,r,l;return a=t.tree.match(/^(.*) in ((?:.*\.)?(.*)) at (.*)$/),o=a[1],i=a[2],r=a[3],l=a[4],function(e,t){function a(e){for(var t=s.length;t--;)if(s[t].scope[o]===e)return s.splice(t,1)[0]}var c=t[0].parentNode,s=[];e.$watch(i,function(t){var i=[],u=function(e,t,c,d){for(var p,m,f,v,g,y=0,h=e.length,$=h-1,k=function(e,n){n[o]=m,f={scope:n,parentScope:c,element:e[0],branch:"none"==l?e[0]:e.find(l)[0]},t.insertBefore(f.element,p)};h>y;++y)p=t.childNodes[y],m=e[y],f=a(m),f&&f.parentScope!==c&&(s.push(f),f=null),f?f.element!==p&&t.insertBefore(f.element,p):n(c.$new(),k),v=f.scope,v.$depth=d,v.$index=y,v.$first=0===y,v.$last=y===$,v.$middle=!(v.$first||v.$last),i.push(f),g=m[r],g&&g.length&&u(g,f.branch,v,d+1)};u(t,c,e,0);for(var d=s.length;d--;){var p=s[d];p.scope&&p.scope.$destroy(),p.element&&p.element.parentNode.removeChild(p.element)}s=i},!0)}}}}).directive("colorPicker",["$compile",function(){return{scope:{which:"@which"},template:'<div class="tr-sq" ng-show="$parent.data.selection.active.typeNum==1"><input type="text" class="swatch" style="background-color:{{$parent.data.drawStyle[which]}}" ng-model="$parent.data.drawStyle[which]" colorpicker="rgba"  colorpicker-position="value" colorpicker-position-value="-100,40" colorpicker-parent colorpicker-with-input="true" /></div><div class="tr-sq" ng-show="$parent.data.selection.active.typeNum==2"><input type="text" class="swatch" style="background-color:{{$parent.data.selection.active.styles[$parent.data.flags.screenState][$parent.data.flags.elementState][which]}}" ng-model="$parent.data.selection.active.styles[$parent.data.flags.screenState][$parent.data.flags.elementState][which]" colorpicker="rgba"  colorpicker-position="value" colorpicker-position-value="-100,40" colorpicker-parent colorpicker-with-input="true" /></div>'}}]).directive("drawstyleSelectionModifier",["$compile",function(){return{scope:{inputType:"@inputType",inputClass:"@inputClass",which:"@which"},template:'<input ng-show="$parent.data.selection.active.typeNum==1" type="{{::inputType}}" class="{{::inputClass}}" which="{{::which}}" ng-model="$parent.data.drawStyle[which]" x-key-increment /><input ng-show="$parent.data.selection.active.typeNum==2" type="{{::inputType}}" class="{{::inputClass}}" which="{{::which}}" ng-model="$parent.data.selection.active.styles[$parent.data.flags.screenState][$parent.data.flags.elementState][which]" x-key-increment />'}}]).directive("listenKeystrokes",["$compile",function(e){return function(t){$(window).on("keydown.listenKeystrokes keyup.listenKeystrokes",function(n){"undefined"!=typeof t.data.keystrokes[n.keyCode]&&"undefined"!=typeof t.data.keystrokes[n.keyCode][n.type]&&t.data.keystrokes[n.keyCode][n.type]({e:n,s:t,c:e});try{"$apply"!=t.$root.$$phase&&"$digest"!=t.$root.$$phase&&t.$apply()}catch(a){}})}}]).directive("flyoutMenu",[function(){return{restrict:"A",scope:{menus:"=flyoutMenu",menuId:"@id"},template:'<div class="flyoutMenuWrapper" ng-mouseleave="menus.activeMenu=null">	<div ng-repeat="(menuName,menu) in menus.menus" id="{{::menuName}}Menu" class="flyout-menu">		<button id="{{::menuName}}MenuButton" type="button" ng-class="::menu.iconClass" ng-click="menus.activeMenu = {true:null,false:menuName}[menus.activeMenu==menuName]" ng-mouseover="menus.activeMenu = {true:null,false:menuName}[menus.activeMenu==null]">{{::menu.label}}</button>		<div class="flyout" ng-show="(menus.activeMenu==menuName)">			<div ng-repeat="action in menu.actions"><button ng-if="!action.separator" ng-click="action.fn($parent);menus.activeMenu=null" ng-disabled="action.disabled">{{::action.label}} <i ng-if="action.hasCheck" class="fa fa-check pull-right"></i></button><hr ng-if="action.separator"/></div>		</div>	</div></div>'}}]).directive("inlineStyles",[function(){return{scope:{element:"=ngModel",preview:"@preview"},template:"{{styleString}}",link:function(e){var t=function(){e.styleString="";var t=function(n){if("undefined"!=typeof n.styles){var a=n.styles,o="#screen_"+n.id;for(var i in a)for(var r in a[i])if("normal"!=r){var l="base"==i?"":"."+i+" ";e.styleString+=l+o+("undefined"!=typeof e.preview?r:r.replace(":",".colon__"))+"{";for(var c in a[i][r])e.styleString+=c+":"+a[i][r][c]+" !important;";e.styleString+="}"}}if(n.children.length>0)for(var s=0;s<n.children.length;s++)t(n.children[s])};t(e.element)};e.$watch("element",function(){t()},!0)}}}]).directive("uploadToModel",[function(){return{scope:{model:"=ngModel",uploadWrapper:"@uploadWrapper"},link:function(e,t){var n=t[0];n.addEventListener("change",function(){var t=n.files[0],a=/image.*/;if(t.type.match(a)){var o=new FileReader;o.onload=function(){console.log(e.uploadWrapper),e.model=e.uploadWrapper.replace("file-data",o.result),"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},o.readAsDataURL(t)}else alert("File not supported!")})}}}]).directive("cursorClass",function(){return{scope:{model:"=ngModel"},template:"div.element{cursor:{{model}} !important;}"}}).directive("ngDragstart",function(){return{scope:{dragStart:"=ngDragstart",dataElement:"=ngModel"},link:function(e,t,n){t.on("dragstart",function(a){e.dragStart(a,e,t,n)})}}}).directive("ngDrop",function(){return{scope:{dropFunc:"=ngDrop",dragOverFunc:"=ngDragover",dragLeaveFunc:"=ngDragleave",parentElement:"=ngParentElement",child:"=ngChildElement"},link:function(e,t,n){t.on("drop",function(a){e.dropFunc(a,e,t,n)}).on("dragover",function(a){e.dragOverFunc(a,e,t,n)}).on("dragleave",function(a){e.dragLeaveFunc(a,e,t,n)})}}});