angular.module("gui.directives",["gui.filters"]).directive("keyIncrement",[function(){return function(e,t){t.on("keydown",function(e){var a=e.keyCode,n=function(e){var a=t.val(),n=parseInt(a.replace(/[^-\d\.]/g,"")),i=n+e,o=a.replace(n,"");t.val(i+(""===o?"px":o)).triggerHandler("input")};40==a?n(-1):38==a&&n(1)})}}]).directive("toolbox",["launcherFilter",function(){return{scope:{toolbox:"@toolbox",data:"=data"},template:'<button ng-repeat="(key,value) in data.tools | launcher:toolbox" type="button" class="btn" ng-class="{active: value.isActive}" set-tool="{{value.id}}" title="{{value.label}}" ng-attr-is-default="{{value.isDefault}}"><span class="{{value.iconClass}}"></span></button>'}}]).directive("setTool",["$compile",function(e){return{link:function(t,a,n){t.data.fn.setTool(t,a,n,e)}}}]).directive("trackMouseEvents",["$compile",function(e){return function(t,a){a.on("mousedown mouseup mouseenter mouseleave",function(a){a.preventDefault();var n=a.target,i=t.data.tools,o=$("#horizontalRuler"),c=$("#rulerHGuide"),r=$("#verticalRuler"),l=$("#rulerVGuide"),s=$("#rulers"),d={event:a,scope:t,compile:e};n==o||n==c?i.addGuide.horizontal[a.type](d):n==r||n==l?i.addGuide.vertical[a.type](d):n==s||(i.addGuide.isActive?i.addGuide[i.addGuide.isActive][a.type](d):("function"==typeof i[t.data.tool].setUndo&&i[t.data.tool].setUndo(d),"function"==typeof i[t.data.tool][a.type]&&i[t.data.tool][a.type](d)))})}}]).directive("trackMousePosition",[function(){return function(e,t){t.on("mousemove",function(t){var a=$("#screen").offset();e.$apply(function(){e.data.mouse.y=t.pageX,e.data.mouse.x=t.pageY,e.data.screen.mouse.x=t.pageX-a.left,e.data.screen.mouse.y=t.pageY-a.top}),e.data.tools[e.data.tool].mousemove(t,e)})}}]).directive("modal",[function(){return{transclude:!0,templateUrl:"templates/modal.html",scope:{},link:function(e,t){e.content="Hello modals",t.on("click",function(e){e.target==t[0]&&t.remove()})}}}]).directive("showElements",function(e){return{scope:{family:"="},templateUrl:"templates/tree.html",compile:function(t){return e.compile(t)}}}).directive("tree",function(){return{restrict:"A",transclude:"element",priority:1e3,terminal:!0,compile:function(e,t,a){var n,i,o,c,r;return n=t.tree.match(/^(.*) in ((?:.*\.)?(.*)) at (.*)$/),i=n[1],o=n[2],c=n[3],r=n[4],function(e,t){function n(e){for(var t=s.length;t--;)if(s[t].scope[i]===e)return s.splice(t,1)[0]}var l=t[0].parentNode,s=[];e.$watch(o,function(t){var o=[],d=function(e,t,l,u){for(var p,h,y,f,v,m=0,w=e.length,k=w-1;w>m;++m)p=t.childNodes[m],h=e[m],y=n(h),y&&y.parentScope!==l&&(s.push(y),y=null),y?y.element!==p&&t.insertBefore(y.element,p):a(l.$new(),function(e,a){a[i]=h,y={scope:a,parentScope:l,element:e[0],branch:"none"==r?e[0]:e.find(r)[0]},t.insertBefore(y.element,p)}),f=y.scope,f.$depth=u,f.$index=m,f.$first=0===m,f.$last=m===k,f.$middle=!(f.$first||f.$last),o.push(y),v=h[c],v&&v.length&&d(v,y.branch,f,u+1)};d(t,l,e,0);for(var u=s.length;u--;){var p=s[u];p.scope&&p.scope.$destroy(),p.element&&p.element.parentNode.removeChild(p.element)}s=o},!0)}}}}).directive("colorPicker",["$compile",function(){return{scope:{which:"@which"},template:'<div class="tr-sq"><input type="text" class="swatch" style="background-color:{{$parent.data.stylePickers[which]}}" ng-model="$parent.data.stylePickers[which]" colorpicker="rgba"  colorpicker-position="value" colorpicker-position-value="0,40" colorpicker-parent colorpicker-with-input="true" /></div>',link:function(e){var t=e.$parent;"undefined"==typeof t.data.stylePickers&&(t.stylePickers={}),t.data.stylePickers[e.which]=t.data.drawStyle[e.which];var a=function(){var a=t.data.selection.active;t.data.stylePickers[e.which]="layer"==a.type?t.data.drawStyle[e.which]:a.style[e.which]};a(),t.$watch("data.selection",function(){a()}),t.$watch('data.stylePickers["'+e.which+'"]',function(a){"layer"==t.data.selection.active.type?t.data.drawStyle[e.which]=a:t.data.selection.active.style[e.which]=a})}}}]).directive("drawstyleSelectionModifier",["$compile",function(){return{scope:{inputType:"@inputType",inputClass:"@inputClass",which:"@which"},template:'<input type="{{inputType}}" class="{{inputClass}}" which="{{which}}" ng-model="$parent.data.stylePickers[which]" x-key-increment />',link:function(e){s=e.$parent,"undefined"==typeof s.data.stylePickers&&(s.data.stylePickers={}),s.data.stylePickers[e.which]=s.data.drawStyle[e.which];var t=function(){var t=s.data.selection.active;s.data.stylePickers[e.which]="layer"==t.type?s.data.drawStyle[e.which]:t.style[e.which]};t(),s.$watch("data.selection",function(){t()}),s.$watch('data.stylePickers["'+e.which+'"]',function(t){"layer"==s.data.selection.active.type?s.data.drawStyle[e.which]=t:s.data.selection.active.style[e.which]=t})}}}]).directive("listenKeystrokes",["$compile",function(e){return function(t){$(window).on("keydown keyup",function(a){console.log(a),"undefined"!=typeof t.data.keystrokes[a.keyCode]&&"undefined"!=typeof t.data.keystrokes[a.keyCode][a.type]&&t.data.keystrokes[a.keyCode][a.type]({e:a,s:t,c:e})})}}]);